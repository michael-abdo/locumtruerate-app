<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Auto-Print Issue</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        .success { border-left-color: #28a745; }
        .log { 
            background: #1a1a1a; 
            color: #00ff00; 
            font-family: monospace; 
            padding: 15px; 
            border-radius: 4px; 
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-btn { background: #28a745; }
        .clear-btn { background: #6c757d; }
    </style>
</head>
<body>
    <h1>üîç Auto-Print Debug Tool</h1>
    
    <div class="debug-box">
        <h3>Debug Information</h3>
        <p><strong>Purpose:</strong> This tool helps identify what's causing auto-print on page load</p>
        <p><strong>URL:</strong> <span id="current-url"></span></p>
        <p><strong>Timestamp:</strong> <span id="timestamp"></span></p>
    </div>

    <div class="debug-box">
        <h3>Test Controls</h3>
        <button onclick="testPrintFunction()" class="test-btn">üñ®Ô∏è Test Print Function</button>
        <button onclick="clearLogs()" class="clear-btn">üßπ Clear Logs</button>
        <button onclick="checkPrintTriggers()">üîç Check Print Triggers</button>
    </div>

    <div class="debug-box">
        <h3>Event Log</h3>
        <div id="event-log" class="log">Initializing debug tool...\n</div>
    </div>

    <div class="debug-box">
        <h3>Environment Data</h3>
        <div id="env-data" class="log"></div>
    </div>

    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toISOString();
            const logElement = document.getElementById('event-log');
            const prefix = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : 'üìù';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            
            // Also log to browser console for additional debugging
            console.log(`DEBUG-TOOL: ${message}`);
        }

        function clearLogs() {
            document.getElementById('event-log').textContent = 'Logs cleared...\n';
            logCount = 0;
            log('Logs cleared by user');
        }

        // Safe print function with comprehensive guards
        function testPrintFunction() {
            log('üñ®Ô∏è testPrintFunction() called', 'info');
            
            // Check if this was triggered by user interaction
            if (typeof event === 'undefined' || !event) {
                log('‚ùå No event object - this was called programmatically!', 'error');
                return;
            }
            
            if (event.isTrusted === false) {
                log('‚ùå Event is not trusted - this was triggered by script!', 'error');
                return;
            }
            
            if (!event.target || !event.target.closest || !event.target.closest('button')) {
                log('‚ùå Event was not triggered by button click!', 'error');
                return;
            }
            
            log('‚úÖ All safety checks passed - this was a genuine user click', 'success');
            log('üñ®Ô∏è Would normally call window.print() here, but skipping for debug', 'info');
            // window.print(); // Commented out for safety during debugging
        }

        function checkPrintTriggers() {
            log('üîç Checking for potential auto-print triggers...', 'info');
            
            // Check for print-related functions in global scope
            const globalPrintFunctions = [];
            if (typeof window.printResults === 'function') globalPrintFunctions.push('printResults');
            if (typeof window.print === 'function') globalPrintFunctions.push('window.print');
            if (typeof window.exportCSV === 'function') globalPrintFunctions.push('exportCSV');
            if (typeof window.exportAnalysis === 'function') globalPrintFunctions.push('exportAnalysis');
            
            log(`Found global print functions: ${globalPrintFunctions.join(', ')}`, 'info');
            
            // Check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            log(`URL parameters: ${window.location.search || 'none'}`, 'info');
            for (let [key, value] of urlParams) {
                log(`  - ${key} = ${value}`, 'info');
            }
            
            // Check localStorage
            const localStorageKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                localStorageKeys.push(key);
            }
            log(`localStorage keys: ${localStorageKeys.join(', ') || 'none'}`, 'info');
            
            // Check for any print-related data
            localStorageKeys.forEach(key => {
                if (key.toLowerCase().includes('print') || key.toLowerCase().includes('export')) {
                    const value = localStorage.getItem(key);
                    log(`  - ${key} = ${value?.substring(0, 100)}...`, 'warning');
                }
            });
            
            // Check for timeouts or intervals
            log('Checking for active timeouts/intervals...', 'info');
            // Note: Can't easily detect existing timeouts, but can monitor new ones
            
            log('‚úÖ Print trigger check complete', 'success');
        }

        function captureEnvironmentData() {
            const envData = {
                userAgent: navigator.userAgent,
                url: window.location.href,
                referrer: document.referrer,
                timestamp: new Date().toISOString(),
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                loadTime: performance.now(),
                readyState: document.readyState
            };
            
            document.getElementById('env-data').textContent = JSON.stringify(envData, null, 2);
            log('Environment data captured', 'info');
        }

        // Initialize debug tool
        function initDebugTool() {
            log('üöÄ Debug tool initialized', 'success');
            
            // Update page info
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
            
            // Capture environment
            captureEnvironmentData();
            
            // Monitor for any calls to window.print
            const originalPrint = window.print;
            window.print = function() {
                log('üö® ALERT: window.print() was called!', 'error');
                log('Call stack: ' + new Error().stack, 'error');
                // Don't actually print during debugging
                // originalPrint.apply(this, arguments);
            };
            
            // Monitor for printResults calls if it exists
            if (typeof window.printResults === 'function') {
                const originalPrintResults = window.printResults;
                window.printResults = function() {
                    log('üö® ALERT: printResults() was called!', 'error');
                    log('Call stack: ' + new Error().stack, 'error');
                    // Don't actually print during debugging
                    // originalPrintResults.apply(this, arguments);
                };
            }
            
            log('Print function monitoring enabled', 'info');
        }

        // Start monitoring immediately
        initDebugTool();
        
        // Also monitor page events
        window.addEventListener('load', function() {
            log('üîÑ Window load event fired', 'info');
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            log('üîÑ DOMContentLoaded event fired', 'info');
        });
        
        // Monitor for any potential auto-execution
        setTimeout(() => {
            log('‚è∞ 1 second timeout check - no auto-print detected', 'success');
        }, 1000);
        
        setTimeout(() => {
            log('‚è∞ 3 second timeout check - still no auto-print detected', 'success');
        }, 3000);
    </script>
</body>
</html>